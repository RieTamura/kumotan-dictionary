# 辞書自動更新ワークフロー
# フィードバックIssueに「approved」ラベルが付与されたとき、
# overrides.jsonに自動で修正エントリを追加します。

name: Dictionary Auto Update

on:
  issues:
    types: [labeled]

jobs:
  update-overrides:
    # 条件: 「approved」ラベルが付与され、かつ「word_search」ラベルを持つIssue
    if: github.event.label.name == 'approved' && contains(github.event.issue.labels.*.name, 'word_search')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Parse Issue and Update overrides.json
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const issue = context.payload.issue;

            // Issue本文から情報を抽出
            const body = issue.body || '';

            // フィードバックフォームのフォーマットに合わせて抽出
            // 例: **対象/件名**: example
            // 例: **詳細/期待内容**: 正しい意味
            const wordMatch = body.match(/\*\*対象\/件名\*\*:\s*(.+)/);
            const correctionMatch = body.match(/\*\*詳細\/期待内容\*\*:\s*(.+)/);
            const posMatch = body.match(/\*\*品詞\*\*:\s*(.+)/);
            const postUrlMatch = body.match(/\*\*投稿リンク\*\*:\s*(.+)/);

            // 英語フォーマットにも対応
            const wordMatchEn = body.match(/\*\*Word\*\*:\s*(.+)/);
            const correctionMatchEn = body.match(/\*\*Correct meaning\*\*:\s*(.+)/);

            const word = (wordMatch?.[1] || wordMatchEn?.[1] || '').trim();
            const correctedMeaning = (correctionMatch?.[1] || correctionMatchEn?.[1] || '').trim();
            const partOfSpeech = posMatch ? posMatch[1].trim() : null;
            const postUrl = postUrlMatch ? postUrlMatch[1].trim() : null;

            if (!word || !correctedMeaning) {
              console.log('Required fields not found in issue body');
              console.log('Issue body:', body);
              console.log('Word found:', word);
              console.log('Correction found:', correctedMeaning);
              return;
            }

            // overrides.json を読み込み
            let overrides = { version: "1.0.0", updated_at: "", entries: [] };
            const filePath = 'overrides.json';
            if (fs.existsSync(filePath)) {
              try {
                overrides = JSON.parse(fs.readFileSync(filePath, 'utf8'));
              } catch (e) {
                console.log('Failed to parse existing overrides.json, creating new one');
              }
            }

            // 重複チェック（同じ単語が既に登録されている場合は更新）
            const existingIndex = overrides.entries.findIndex(
              e => e.word.toLowerCase() === word.toLowerCase()
            );

            const newEntry = {
              id: `override_${Date.now()}`,
              type: "correction",
              word: word,
              corrected_meaning: correctedMeaning,
              part_of_speech: partOfSpeech,
              post_url: postUrl,
              source_issue: issue.number,
              approved_at: new Date().toISOString()
            };

            if (existingIndex >= 0) {
              // 既存エントリを更新
              overrides.entries[existingIndex] = newEntry;
              console.log(`Updated existing entry for word: ${word}`);
            } else {
              // 新しいエントリを追加
              overrides.entries.push(newEntry);
              console.log(`Added new entry for word: ${word}`);
            }

            overrides.updated_at = new Date().toISOString();

            // ファイルを保存（整形して出力）
            fs.writeFileSync(filePath, JSON.stringify(overrides, null, 2) + '\n');
            console.log(`Successfully updated overrides.json with ${overrides.entries.length} entries`);

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add overrides.json
          git diff --staged --quiet || git commit -m "chore: add dictionary override from issue #${{ github.event.issue.number }}"
          git push

  # フローB: search-improvementラベルが付与されたときにPRを自動作成
  create-search-improvement-pr:
    if: github.event.label.name == 'search-improvement' && contains(github.event.issue.labels.*.name, 'word_search')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Create branch and PR from Issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const branchName = `search-improvement/issue-${issue.number}`;

            // mainブランチの最新SHAを取得
            const mainRef = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'heads/main'
            });

            // ブランチ作成
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/heads/${branchName}`,
              sha: mainRef.data.object.sha
            });

            console.log(`Created branch: ${branchName}`);

            // PR作成
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `検索改善: ${issue.title}`,
              body: `Closes #${issue.number}\n\n${issue.body}\n\n---\n_このPRはIssue #${issue.number} から自動作成されました。_`,
              head: branchName,
              base: 'main'
            });

            console.log(`Created PR #${pr.data.number}: ${pr.data.html_url}`);
